## ğŸ“… êµ¬í˜„ ì¼ì
2025-04-29

## ğŸ§© ê¸°ëŠ¥ ìš”ì•½
ì‚¬ìš©ìê°€ í•˜ë£¨ì— í•œ ë²ˆ ì¹œêµ¬ì—ê²Œ "í–‰ìš´ìºì‹œ" ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥.
ìˆ˜ì‹ ìëŠ” ì´ë¥¼ í´ë¦­í•´ ë³µê¶Œì²˜ëŸ¼ ê¸ìœ¼ë©´ ëœë¤ í¬ì¸íŠ¸ ë³´ìƒì„ ë°›ìŒ.
- âœ… ë°œì†¡ì€ ì¼ë°˜ ìœ ì € í•˜ë£¨ 1íšŒë¡œ ì œí•œ (ê´€ë¦¬ì ì˜ˆì™¸)
- âœ… ì´ë¯¸ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ë‹¤ì‹œ ë³´ë‚¼ ìˆ˜ ì—†ìŒ
- âœ… ë°›ëŠ” ì‚¬ëŒë§Œ ì˜¤í”ˆ ê°€ëŠ¥
- âœ… í•˜ë£¨ê°€ ì§€ë‚˜ë©´ ë³µê¶Œì€ ìë™ ë§Œë£Œ ì²˜ë¦¬

---

## ğŸ¯ êµ¬í˜„ ëª©í‘œ
- í–‰ìš´ìºì‹œ ì „ì†¡ ê¸°ë¡ì„ DBì— ë‚¨ê¸°ê³  opened / expired ìƒíƒœë¥¼ ê´€ë¦¬
- ë©”ëª¨ë¦¬ ìºì‹œ ì œê±°í•˜ê³  ì™„ì „í•œ DB ê¸°ë°˜ ìƒíƒœ ì¶”ì  êµ¬ì¡°ë¡œ ë³€ê²½

---

## ğŸ—‚ï¸ ë””ë ‰í† ë¦¬ ë° ì£¼ìš” íŒŒì¼

| íŒŒì¼ëª… | ì„¤ëª… |
|--------|------|
| `LuckyCashHistory.java` | í–‰ìš´ìºì‹œ ì „ì†¡ ê¸°ë¡ìš© ì—”í‹°í‹°
| `LuckyCashHistoryRepository.java` | DB ì ‘ê·¼ìš© ë ˆí¬ì§€í† ë¦¬
| `ChatController.java` | ì „ì†¡ ë° ë³µê¶Œ ì˜¤í”ˆ API ì—”ë“œí¬ì¸íŠ¸ í¬í•¨
| `ChatService.java` | í–‰ìš´ìºì‹œ ë©”ì‹œì§€ ì „ì†¡ ë¡œì§ í¬í•¨
| `LuckyCashService.java` | ìì • ë§Œë£Œ ì²˜ë¦¬ ë° ìƒíƒœ ì¡°íšŒ ì„œë¹„ìŠ¤

---

## âš™ï¸ ì „ì²´ íë¦„ ìš”ì•½

1. `/api/chat/lucky-cash/send` í˜¸ì¶œ â†’ ë©”ì‹œì§€ ì „ì†¡ ë° LuckyCashHistory ìƒì„±
2. `/api/chat/lucky-cash/redeem` í˜¸ì¶œ â†’ ìˆ˜ì‹ ìê°€ ë©”ì‹œì§€ í´ë¦­ ì‹œ ë³µê¶Œ ì˜¤í”ˆ, opened=true ì²˜ë¦¬
3. ìì •ë§ˆë‹¤ Scheduler ì‹¤í–‰ â†’ í•˜ë£¨ ì§€ë‚œ ë¯¸ì˜¤í”ˆ ë³µê¶Œì€ expired=true ì²˜ë¦¬
4. í”„ë¡ íŠ¸ëŠ” opened/expired í•„ë“œë¥¼ ë°›ì•„ ë²„íŠ¼/ë””ìì¸ ë¶„ê¸° ì²˜ë¦¬

---

## ğŸ§¾ ì£¼ìš” ì—”í‹°í‹°: `LuckyCashHistory`
```java
@Entity
public class LuckyCashHistory {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "sender_id")
    private User sender;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "receiver_id")
    private User receiver;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "chat_room_id")
    private ChatRoom chatRoom;

    @OneToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "message_id")
    private ChatMessage message;

    private LocalDate date;
    private boolean opened = false;
    private boolean expired = false;
}
```

---

## ğŸ§  ì¤‘ë³µ ì²´í¬ & opened ì²˜ë¦¬: `ChatController`
```java
@PostMapping("/lucky-cash/redeem")
public ResponseEntity<?> redeemLuckyCash(...) {
    ChatMessage message = chatMessageRepository.findByMessageId(messageId)
        .orElseThrow(...);

    LuckyCashHistory history = luckyCashHistoryRepository.findByMessageId(message.getId())
        .orElseThrow(...);

    if (!history.getReceiver().getId().equals(userId)) {
        return ResponseEntity.status(FORBIDDEN).body(...);
    }

    if (history.isOpened()) {
        return ResponseEntity.status(CONFLICT).body(...);
    }

    pointsService.addReward(userId, reward, PointsType.LUCKY_CASH, ...);

    history.setOpened(true);
    luckyCashHistoryRepository.save(history);

    return ResponseEntity.ok(Map.of("reward", reward, ...));
}
```

---

## â° ë§Œë£Œ ì²˜ë¦¬ Scheduler: `LuckyCashService`
```java
@Scheduled(cron = "0 0 0 * * *")
@Transactional
public void expireUnopenedLuckyCash() {
    LocalDate today = LocalDate.now();

    List<LuckyCashHistory> expiredTargets =
        luckyCashHistoryRepository.findByDateBeforeAndOpenedFalse(today);

    for (LuckyCashHistory history : expiredTargets) {
        history.setExpired(true);
    }

    luckyCashHistoryRepository.saveAll(expiredTargets);
}
```

---

## ğŸ’¡ í”„ë¡ íŠ¸ ì—°ë™ ì‹œ ì£¼ì˜ì‚¬í•­
- ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ opened / expired ê°’ì„ ë°˜ë“œì‹œ ì‘ë‹µì— í¬í•¨í•´ì•¼ í•¨
- ë³´ë‚´ëŠ” ì‚¬ëŒì€ opened ì—¬ë¶€ë¥¼ ë³¼ ìˆ˜ëŠ” ìˆì§€ë§Œ ì§ì ‘ ì˜¤í”ˆì€ ëª» í•¨
- expired ìƒíƒœì¼ ê²½ìš° ë²„íŠ¼ ë¹„í™œì„±í™” + íšŒìƒ‰ ì²˜ë¦¬ ë“± UX ë¶„ê¸° í•„ìˆ˜

---

## âœ… í•™ìŠµí•œ ì 
- ë©”ëª¨ë¦¬ ê¸°ë°˜ ìºì‹œë³´ë‹¤ DB ê¸°ë¡ì´ í›¨ì”¬ ì‹ ë¢°ì„± ìˆê³  ìœ ì§€ ë³´ìˆ˜ì— ìœ ë¦¬í•¨
- í•˜ë£¨ 1íšŒ ì œí•œ, opened / expired ê´€ë¦¬ê¹Œì§€ í¬í•¨ë˜ë©´ ì‹¤ë¬´ ìˆ˜ì¤€ì˜ ë³´ìƒ ì‹œìŠ¤í…œ êµ¬í˜„ ê°€ëŠ¥
- ìì • ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œì§ì€ `@Scheduled`ì™€ JPQL ì¡°í•©ìœ¼ë¡œ ê°„ë‹¨í•˜ê²Œ êµ¬ì¶• ê°€ëŠ¥

---

> ì „ì²´ êµ¬ì¡°ì™€ ìƒíƒœ íë¦„ì„ ì´í•´í•˜ê³  ë‚˜ë©´ ìœ ì‚¬í•œ í¬ì¸íŠ¸ ë³´ìƒ ë¡œì§ì—ë„ ì‰½ê²Œ í™•ì¥ ê°€ëŠ¥í•¨ âœ…