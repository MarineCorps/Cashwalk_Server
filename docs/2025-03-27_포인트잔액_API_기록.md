# β… 2025-03-27 μΊμ‹μ›ν¬ - ν¬μΈνΈ μ”μ•΅ μ΅°ν API κµ¬ν„ κΈ°λ΅

## π§Ύ λ©ν‘
μ‚¬μ©μκ°€ ν„μ¬ λ³΄μ ν• ν¬μΈνΈλ¥Ό ν™•μΈν•  μ μλ” API `/api/points/balance`λ¥Ό κµ¬ν„ν•λ‹¤.
- JWT μΈμ¦μ„ ν†µν•΄ μ‚¬μ©μ μ‹λ³„
- ν•΄λ‹Ή μ‚¬μ©μμ ν¬μΈνΈ μ λ¦½/μ‚¬μ© λ‚΄μ—­μ„ ν•©μ‚°ν•μ—¬ μ΄ μ”μ•΅ κ³„μ‚°
- JSON ν•νƒλ΅ `{ "balance": μ΄ν•© }` μ‘λ‹µ

---

## π“¦ κµ¬ν„ νμΌ κµ¬μ„±

| κ³„μΈµ | νμΌλ… | μ—­ν•  |
|------|--------|------|
| Entity | `Points.java` | ν¬μΈνΈ μ λ¦½/μ‚¬μ© λ‚΄μ—­ ν…μ΄λΈ” |
| Repository | `PointsRepository.java` | ν¬μΈνΈ μ΄ν•© SQL κ³„μ‚° |
| Service | `PointsService.java` | μ‚¬μ©μ ID κΈ°λ° ν¬μΈνΈ κ³„μ‚° |
| DTO | `PointsDto.java` | JSON μ‘λ‹µ κµ¬μ΅° μ •μ |
| Controller | `PointsController.java` | API μ—”λ“ν¬μΈνΈ: `/api/points/balance` |

---

## π’Ύ μ£Όμ” μ½”λ“ μ„¤λ…

### 1. `Points.java`
```java
@Entity
@Table(name = "points")
public class Points {
    @Id @GeneratedValue
    private Long id;

    @ManyToOne @JoinColumn(name = "user_id")
    private User user;

    @Column(nullable = false)
    private int amount; // μ–‘μ: μ λ¦½, μμ: μ‚¬μ©

    @Column(nullable = false)
    private String type; // STEP_REWARD, AD_REWARD λ“±

    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;
}
```

> **@Entity**: μ΄ ν΄λμ¤κ°€ DB ν…μ΄λΈ”λ΅ λ§¤ν•‘λ¨  
> **@ManyToOne**: μ—¬λ¬ ν¬μΈνΈ κΈ°λ΅μ΄ ν•λ‚μ μ‚¬μ©μμ— μ—°κ²°λ¨  
> **amount**: μ λ¦½(+) λλ” μ‚¬μ©(-) κΈ°λ΅μ„ λ¨λ‘ μ €μ¥

---

### 2. `PointsRepository.java`
```java
@Query("SELECT COALESCE(SUM(p.amount), 0) FROM Points p WHERE p.user = :user")
int getTotalPointsByUser(User user);
```

### π§  SQL μΏΌλ¦¬ μƒμ„Έ μ„¤λ…
```sql
SELECT COALESCE(SUM(p.amount), 0)
FROM points p
WHERE p.user_id = ?
```
- `SUM(p.amount)` β†’ ν¬μΈνΈ λ„μ  ν•©μ‚° (μ λ¦½μ€ +, μ‚¬μ©μ€ -)
- `COALESCE(..., 0)` β†’ ν•©κ³„κ°€ nullμΌ κ²½μ° 0μΌλ΅ λ€μ²΄ (μ: κΈ°λ΅ μ—†λ” μ‚¬μ©μ)
- `WHERE p.user_id = ?` β†’ ν„μ¬ λ΅κ·ΈμΈν• μ‚¬μ©μμ— ν•΄λ‹Ήν•λ” κΈ°λ΅λ§ μ΅°ν

---

### 3. `PointsService.java`
```java
User user = userRepository.findById(userId)
        .orElseThrow(() -> new UsernameNotFoundException(...));
int total = pointsRepository.getTotalPointsByUser(user);
return new PointsDto(total);
```

---

### 4. `PointsController.java`
```java
@GetMapping("/balance")
public ResponseEntity<PointsDto> getPointBalance(
        @AuthenticationPrincipal CustomUserDetails userDetails) {
    return ResponseEntity.ok(
        pointsService.getPointBalance(userDetails.getUserId()));
}
```

---

## β… μµμΆ… ν…μ¤νΈ κ²°κ³Ό

### β… μ”μ²­
```
GET /api/points/balance
Authorization: Bearer {{ JWT }}
```

### β… μ‘λ‹µ
```json
{
  "balance": 320
}
```

---

## π§© μ—¬κΈ°μ„λ¶€ν„° β†’ μ΄λ ‡κ² λ§λ¬΄λ¦¬

| λ‹¨κ³„ | ν• μΌ |
|------|--------|
| 1λ‹¨κ³„ | `Points.java`λ΅ ν¬μΈνΈ μ λ¦½/μ‚¬μ© λ‚΄μ—­ μ €μ¥ κµ¬μ΅° μ„¤κ³„ |
| 2λ‹¨κ³„ | SQLλ΅ ν•©κ³„λ¥Ό κ³„μ‚°ν•λ” Repository μΏΌλ¦¬ μ‘μ„± |
| 3λ‹¨κ³„ | μ‚¬μ©μ IDλ΅ ν¬μΈνΈ κ³„μ‚°ν•λ” Service κµ¬ν„ |
| 4λ‹¨κ³„ | μ‘λ‹µ κµ¬μ΅° μ •μ (DTO) |
| 5λ‹¨κ³„ | Controllerμ—μ„ API μ—°κ²° μ™„λ£ |
| β… κ²°κ³Ό | Postmanμ—μ„ μ •μƒ μ‘λ‹µ ν™•μΈ β†’ `{ "balance": 320 }`

---

## β­οΈ λ‹¤μ λ©ν‘
π‘‰ ν¬μΈνΈ μ λ¦½/μ‚¬μ© μ΄λ ¥ μ΅°ν API `/api/points/history` κµ¬ν„  
- μµκ·Ό μ μ •λ ¬  
- λ‚ μ§, κΈμ•΅, μ ν• λ“± ν¬ν•¨
